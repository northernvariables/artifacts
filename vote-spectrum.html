import React, { useState, useMemo } from 'react';
import { BarChart, Bar, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, Cell, ResponsiveContainer, ZAxis } from 'recharts';

const VoteCompass = () => {
  const [screen, setScreen] = useState('welcome');
  const [province, setProvince] = useState('');
  const [responses, setResponses] = useState({});
  const [questionImportance, setQuestionImportance] = useState({});
  const [importance, setImportance] = useState({});
  const [knowledgeAnswers, setKnowledgeAnswers] = useState({});
  const [strategyAnswers, setStrategyAnswers] = useState({});
  const [pastVote2021, setPastVote2021] = useState('');
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [showMilestone, setShowMilestone] = useState(false);
  const [milestoneMessage, setMilestoneMessage] = useState('');
  const [milestonesShown, setMilestonesShown] = useState(new Set());
  const [consentToShare, setConsentToShare] = useState(false);
  const [dataSubmitted, setDataSubmitted] = useState(false);

  // Questions from the JSON
  const allQuestions = [
    {
      qid: "CURR_CARBON_2025_1",
      text: "Given Ottawa has set the federal consumer fuel charge to $0 as of April 1, 2025, Canada should permanently drop consumer carbon pricing and rely on other tools.",
      jurisdiction: "federal",
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: 1 },
        { axis_id: "climate_resources", weight: 1.0, polarity: 1 }
      ]
    },
    {
      qid: "CURR_US_TARIFFS_2025",
      text: "Canada should maintain retaliatory tariffs against the U.S. even if it increases costs for Canadian consumers and businesses.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "foreign_defence", weight: 0.8, polarity: 1 },
        { axis_id: "economic_model", weight: 0.4, polarity: -1 }
      ]
    },
    {
      qid: "CURR_HOUSING_CRISIS",
      text: "The federal government should acquire public land and directly build rent-controlled housing rather than rely on private developers.",
      jurisdiction: "federal",
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 1.0, polarity: -1 },
        { axis_id: "populism", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "CURR_CARNEY_LEADERSHIP",
      text: "Mark Carney's experience as a central banker makes him better equipped than previous leaders to handle Canada's economic challenges.",
      jurisdiction: "federal",
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "populism", weight: 0.8, polarity: -1 },
        { axis_id: "institutional_trust", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "CURR_AUTOMATIC_TAX_FILING",
      text: "The federal government should implement automatic tax filing for low-income Canadians to reduce barriers to accessing benefits.",
      jurisdiction: "federal",
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 },
        { axis_id: "institutional_trust", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "CURR_PALESTINE_RECOGNITION",
      text: "Canada's decision to recognize Palestinian statehood is an appropriate step to pressure Israel toward a two-state solution.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "foreign_defence", weight: 0.9, polarity: -1 },
        { axis_id: "social_values", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "CURR_NOTWITHSTANDING_LIMITS",
      text: "The Supreme Court should place limits on provincial use of the notwithstanding clause to protect individual rights.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "federalism", weight: 0.8, polarity: -1 },
        { axis_id: "civil_liberties", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "CURR_GOLDEN_DOME",
      text: "Canada should join the U.S. Golden Dome missile defence system to strengthen continental security.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "foreign_defence", weight: 1.0, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "CURR_IMM_TEMP_5PCT",
      text: "The federal plan to reduce temporary residents (including international students) as a share of population is the right move to relieve housing and services pressures.",
      jurisdiction: "federal",
      issue_bucket: "immigration",
      axis_map: [
        { axis_id: "immigration", weight: 1.0, polarity: 1 }
      ]
    },
    {
      qid: "CURR_INDIGENOUS_PROCUREMENT",
      text: "The federal government should strengthen fraud prevention in Indigenous procurement programs, even if it adds administrative burden.",
      jurisdiction: "federal",
      issue_bucket: "indigenous_reconciliation",
      axis_map: [
        { axis_id: "reconciliation", weight: 0.7, polarity: 1 },
        { axis_id: "institutional_trust", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CURR_CBC_FUNDING",
      text: "The federal government should continue funding CBC/Radio-Canada at current or increased levels to maintain public broadcasting.",
      jurisdiction: "federal",
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: -1 },
        { axis_id: "populism", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "CURR_CHINESE_EV_TARIFFS",
      text: "Canada should maintain its 100% tariff on Chinese electric vehicles to protect domestic industry.",
      jurisdiction: "federal",
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.8, polarity: 1 },
        { axis_id: "climate_resources", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "CURR_PHARMACARE",
      text: "The Pharmacare Act should be implemented quickly with federal funding, even if it requires hard negotiations with provinces.",
      jurisdiction: "federal",
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "CURR_NATO_2PCT",
      text: "Canada should raise defence spending to meet (or exceed) NATO's 2% of GDP target on the current timetable.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "foreign_defence", weight: 1.0, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "ECON_PROGRESSIVE_TAX",
      text: "High-income households should pay higher overall taxes to fund expanded social programs.",
      jurisdiction: "federal",
      issue_bucket: "economy_taxes",
      axis_map: [{ axis_id: "economic_model", weight: 1.0, polarity: -1 }]
    },
    {
      qid: "ECON_BALANCED_BUDGETS",
      text: "The federal government should prioritize returning to balanced budgets over new spending.",
      jurisdiction: "federal",
      issue_bucket: "economy_taxes",
      axis_map: [{ axis_id: "economic_model", weight: 1.0, polarity: 1 }]
    },
    {
      qid: "SOC_GUN_POLICY",
      text: "Canada should tighten gun laws further even if lawful owners face more burden.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "social_values", weight: 0.8, polarity: -1 },
        { axis_id: "civil_liberties", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "IMM_LEVELS_GENERAL",
      text: "Overall permanent immigration levels should be higher than today.",
      jurisdiction: "federal",
      issue_bucket: "immigration",
      axis_map: [{ axis_id: "immigration", weight: 1.0, polarity: -1 }]
    },
    {
      qid: "CIVIL_LIBERTIES_SURVEILLANCE",
      text: "Police and national security agencies should get broader powers to monitor suspected threats online.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "civil_liberties", weight: 1.0, polarity: 1 }
      ]
    },
    {
      qid: "RECONCILIATION_UNDRIP",
      text: "Governments should move faster to implement UNDRIP and support Indigenous self-government.",
      jurisdiction: "federal",
      issue_bucket: "indigenous_reconciliation",
      axis_map: [{ axis_id: "reconciliation", weight: 1.0, polarity: -1 }]
    },
    {
      qid: "POPULISM_TECHNOCRACY",
      text: "Experts and non-partisan public servants should have a stronger role in setting complex policies.",
      jurisdiction: "federal",
      issue_bucket: "ethics_governance",
      axis_map: [{ axis_id: "populism", weight: 1.0, polarity: -1 }]
    },
    {
      qid: "FOREIGN_DEFENCE_PEACE",
      text: "Canada should put more emphasis on diplomacy and peacekeeping rather than expanding combat capability.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [{ axis_id: "foreign_defence", weight: 1.0, polarity: -1 }]
    },
    {
      qid: "CONT_DIGITAL_ID",
      text: "Canada should implement a national digital ID system to streamline government services and reduce fraud.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "civil_liberties", weight: 1.0, polarity: 1 },
        { axis_id: "institutional_trust", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_15MIN_CITIES",
      text: "Municipal governments should adopt '15-minute city' planning (where essential services are within a 15-minute walk or bike ride) to reduce car dependence.",
      jurisdiction: "federal",
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.8, polarity: -1 },
        { axis_id: "populism", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "CONT_WEF_ENGAGEMENT",
      text: "Canadian leaders should continue engaging with international forums like the World Economic Forum (WEF) to shape global policy.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "populism", weight: 1.0, polarity: -1 },
        { axis_id: "institutional_trust", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_BUY_CANADIAN",
      text: "The federal government should require procurement policies that prioritize Canadian companies and products, even if they cost more.",
      jurisdiction: "federal",
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: -1 },
        { axis_id: "populism", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_TRUMP_APPROACH",
      text: "Canada should take a confrontational stance against Trump's policies rather than seeking compromise and negotiation.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "foreign_defence", weight: 0.8, polarity: -1 },
        { axis_id: "populism", weight: 0.4, polarity: -1 }
      ]
    },
    {
      qid: "CONT_US_BORDER_RESTRICTIONS",
      text: "Canada should maintain stricter border controls and screening for travelers from the United States, even if it slows cross-border travel.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "civil_liberties", weight: 0.7, polarity: 1 },
        { axis_id: "foreign_defence", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_VACCINE_MANDATES",
      text: "The federal government should have the authority to implement vaccine mandates for certain sectors during public health emergencies.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "civil_liberties", weight: 1.0, polarity: 1 },
        { axis_id: "institutional_trust", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_SUPPLY_MANAGEMENT",
      text: "Canada should maintain supply management systems for dairy, poultry, and eggs even if it raises consumer prices.",
      jurisdiction: "federal",
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.8, polarity: -1 },
        { axis_id: "populism", weight: 0.4, polarity: 1 }
      ]
    },
    {
      qid: "CONT_MONARCHY_ABOLISH",
      text: "Canada should abolish the monarchy and become a republic with an elected head of state.",
      jurisdiction: "federal",
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "social_values", weight: 0.7, polarity: -1 },
        { axis_id: "populism", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_ELECTION_REFORM",
      text: "Canada should replace first-past-the-post voting with proportional representation, even if it leads to more minority governments.",
      jurisdiction: "federal",
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "populism", weight: 0.6, polarity: -1 },
        { axis_id: "institutional_trust", weight: 0.4, polarity: -1 }
      ]
    },
    {
      qid: "CONT_US_POLITICAL_INFLUENCE",
      text: "American political movements and rhetoric have too much influence on Canadian politics and public discourse.",
      jurisdiction: "federal",
      issue_bucket: "foreign_policy_defence",
      axis_map: [
        { axis_id: "foreign_defence", weight: 0.7, polarity: 1 },
        { axis_id: "populism", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "CONT_US_MEDIA_REGULATION",
      text: "Canada should regulate or limit American political content on social media and streaming platforms to protect Canadian political discourse.",
      jurisdiction: "federal",
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "civil_liberties", weight: 0.8, polarity: 1 },
        { axis_id: "foreign_defence", weight: 0.6, polarity: 1 },
        { axis_id: "populism", weight: 0.4, polarity: 1 }
      ]
    },
    {
      qid: "BC_HOUSING_SUPPLY",
      text: "B.C. should further up-zone and fast-track approvals for missing-middle housing even if local neighborhoods object.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.3, polarity: -1 },
        { axis_id: "populism", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "BC_LIQUOR_STRIKE",
      text: "The B.C. government should intervene to end public sector strikes at liquor and cannabis stores to minimize economic disruption.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 },
        { axis_id: "civil_liberties", weight: 0.4, polarity: 1 }
      ]
    },
    {
      qid: "AB_ENERGY_ROYALTIES",
      text: "Alberta should prioritize competitiveness in oil & gas (including stable royalties and carbon capture incentives) to protect jobs.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 1.0, polarity: 1 },
        { axis_id: "economic_model", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "AB_TEACHER_STRIKE",
      text: "The Alberta government should meet teachers' demands for better pay and working conditions even if it requires tax increases.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "education_childcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.8, polarity: -1 },
        { axis_id: "populism", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "ON_RENT_GUIDELINE",
      text: "Ontario should keep strict rent-increase caps to protect tenants even if it discourages new rental investment.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.8, polarity: -1 }
      ]
    },
    {
      qid: "ON_HEALTHCARE_PRIVATIZATION",
      text: "Ontario should expand private clinics for some procedures to reduce wait times, even if it creates a two-tier system.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 1.0, polarity: 1 },
        { axis_id: "social_values", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "QC_BILL96_LANG",
      text: "Quebec should vigorously enforce Bill 96's French-language requirements for business and public services.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "social_values", weight: 0.6, polarity: 1 },
        { axis_id: "federalism", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "QC_CONSTITUTION_2025",
      text: "Quebec's proposed provincial constitution that takes precedence over other laws is necessary to protect Quebec's identity and autonomy.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "federalism", weight: 1.0, polarity: 1 },
        { axis_id: "social_values", weight: 0.4, polarity: 1 }
      ]
    },
    {
      qid: "QC_BILL21_VIEW",
      text: "Quebec's approach to secularism (e.g., Bill 21 restricting religious symbols for public servants) is appropriate for a neutral state.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "social_values", weight: 0.8, polarity: 1 },
        { axis_id: "civil_liberties", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "SK_PUBLIC_SERVICES",
      text: "Saskatchewan should limit public-sector growth to keep taxes low, even if some services are reduced.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "economy_taxes",
      axis_map: [{ axis_id: "economic_model", weight: 1.0, polarity: 1 }]
    },
    {
      qid: "MB_CANOLA_TARIFF_TRADEOFF",
      text: "Canada should remove tariffs on Chinese EVs if it helps lift China's tariffs on Canadian canola and pork exports.",
      jurisdiction: "provincial",
      province_gate: ["MB", "SK"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: 1 },
        { axis_id: "foreign_defence", weight: 0.4, polarity: -1 }
      ]
    },
    {
      qid: "NS_OFFSHORE_WIND",
      text: "Nova Scotia should accelerate offshore wind and grid upgrades, even if electricity rates are higher in the near-term.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.9, polarity: -1 }
      ]
    },
    {
      qid: "NB_HEALTHCARE_RECRUITMENT",
      text: "New Brunswick should offer more aggressive incentives (tax breaks, loan forgiveness) to recruit doctors and nurses.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "PE_HOUSING_PRESSURE",
      text: "P.E.I. should restrict non-resident property ownership to address housing affordability for Islanders.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: -1 },
        { axis_id: "populism", weight: 0.4, polarity: 1 }
      ]
    },
    {
      qid: "NL_OFFSHORE_OIL",
      text: "Newfoundland and Labrador should prioritize offshore oil development over renewable energy transition to maximize provincial revenue.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 1.0, polarity: 1 },
        { axis_id: "economic_model", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "BC_DRUG_DECRIM_CONTINUE",
      text: "B.C. should continue decriminalization of small-quantity drug possession while focusing enforcement on trafficking rather than users.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: -1 },
        { axis_id: "civil_liberties", weight: 0.3, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "BC_PUBLIC_DRUG_USE_BAN",
      text: "Public drug use should be prohibited in most public spaces even if possession is decriminalized.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: 1 },
        { axis_id: "civil_liberties", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "BC_UPZONE_TRANSIT",
      text: "B.C. should mandate significant up-zoning near transit and town centres, even over municipal objections, to increase housing supply.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "populism", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "BC_RENT_CAP_TIGHTEN",
      text: "Government should tighten rent caps to address affordability, even if it risks discouraging some new construction.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "BC_SUPPORTIVE_HOUSING_EXPAND",
      text: "The province should expand purpose-built supportive housing even in the face of strong neighbourhood opposition.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "social_values", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "BC_SURREY_POLICE_COMPLETE",
      text: "The Surrey Police Service transition should be completed as planned.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: 1 },
        { axis_id: "populism", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "BC_TREATMENT_OVER_HARM_REDUCTION",
      text: "B.C. should shift funding toward treatment and recovery relative to harm-reduction services.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "BC_FAST_TRACK_TRANSIT",
      text: "The province should fast-track major transit projects even if it requires higher borrowing.",
      jurisdiction: "provincial",
      province_gate: ["BC"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.4, polarity: -1 },
        { axis_id: "economic_model", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "AB_RENEWABLES_SITING_LIMITS",
      text: "Alberta should restrict where large wind and solar projects can be built to protect farmland and viewscapes.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "AB_REMOVE_RENEWABLES_LIMITS",
      text: "Alberta should accelerate renewable energy by removing new setbacks and siting limits.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: -1 },
        { axis_id: "economic_model", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "AB_POWER_MARKET_RELIABILITY_REFORM",
      text: "Reforming Alberta's electricity market to prioritize reliability is worth short-term investment uncertainty.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: 1 }
      ]
    },
    {
      qid: "AB_CHALLENGE_FED_CARBON_PRICE",
      text: "Alberta should actively challenge federal carbon-pricing decisions it views as regionally unfair.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "federalism", weight: 0.5, polarity: 1 },
        { axis_id: "climate_resources", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "AB_EXPAND_OIL_GAS_CCUS",
      text: "The province should expand oil and gas production while investing in carbon capture, utilization, and storage (CCUS).",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.6, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "AB_EXPAND_PRIVATE_HEALTH",
      text: "Alberta should increase privately delivered options within publicly funded health care to reduce wait times.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "AB_PROVINCIAL_PENSION_PLAN",
      text: "Alberta should pursue a separate provincial pension plan.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "federalism", weight: 0.6, polarity: 1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "AB_LOCAL_CONTROL_ENERGY_SITING",
      text: "Municipalities should have greater authority to approve or refuse energy projects in their area.",
      jurisdiction: "provincial",
      province_gate: ["AB"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "populism", weight: 0.4, polarity: -1 }
      ]
    },
    {
      qid: "SK_PARENTAL_CONSENT_PRONOUNS",
      text: "Schools should require parental consent before students under 16 can change names or pronouns on school records.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "education_childcare",
      axis_map: [
        { axis_id: "social_values", weight: 0.6, polarity: 1 },
        { axis_id: "civil_liberties", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "SK_COURTS_REVIEW_ED_POLICIES",
      text: "Courts should rigorously review education policies affecting students' rights for Charter compliance.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "civil_liberties", weight: 0.5, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "SK_REFUSE_CARBON_GAS_COLLECTION",
      text: "Saskatchewan should refuse to collect the federal carbon charge on home heating natural gas.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "federalism", weight: 0.6, polarity: 1 },
        { axis_id: "climate_resources", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "SK_CARBON_TAX_FREE_GOAL",
      text: "The province should aim to be 'carbon-tax free' for families and businesses.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: 1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "SK_EXPAND_GAS_SMRS",
      text: "Saskatchewan should expand natural gas generation and pursue small modular nuclear reactors to ensure reliable power.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "SK_FREEZE_CROWN_RATE_RIDERS",
      text: "The government should freeze Crown utility charges tied to carbon pricing.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: 1 },
        { axis_id: "climate_resources", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "SK_RURAL_POLICING",
      text: "More provincial funds should go to violent-crime prevention and rural policing.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "civil_liberties_public_safety",
      axis_map: [
        { axis_id: "social_values", weight: 0.5, polarity: 1 }
      ]
    },
    {
      qid: "SK_PUBLIC_WAGE_INFLATION",
      text: "Public-sector wage settlements should track inflation closely even if deficits rise.",
      jurisdiction: "provincial",
      province_gate: ["SK"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "MB_HEALTH_SPEND_DEFICIT",
      text: "Manitoba should significantly increase health-care spending even if it means larger short-term deficits.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: -1 }
      ]
    },
    {
      qid: "MB_STAFFING_OVER_TAX_RELIEF",
      text: "Recruiting more frontline health staff should take priority over broad tax relief.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "MB_REBUILD_ERS_SURGERY",
      text: "Manitoba should reopen or build ERs and add surgical capacity in Winnipeg and regional hubs.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "MB_TIGHTEN_RENT_CONTROL",
      text: "The province should cap rent increases more tightly to address affordability.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "MB_NO_PRIVATE_MRI",
      text: "Public money should not support private MRI or diagnostic clinics.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "MB_INDIGENOUS_HEALTH_PARTNERSHIPS",
      text: "The province should accelerate Indigenous-led health partnerships and community-based services.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "indigenous_reconciliation",
      axis_map: [
        { axis_id: "reconciliation", weight: 0.5, polarity: -1 },
        { axis_id: "economic_model", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "MB_HYDRO_RATE_STABILITY",
      text: "Hydro rates should be held down even if it slows debt reduction at Manitoba Hydro.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "MB_CLIMATE_ADAPTATION",
      text: "Manitoba should increase climate adaptation spending for floods, fires, and drought.",
      jurisdiction: "provincial",
      province_gate: ["MB"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "ON_HIGHWAY_413_PROCEED",
      text: "Ontario should proceed with Highway 413 to ease congestion and support growth.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.4, polarity: 1 },
        { axis_id: "economic_model", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "ON_HIGHWAY_413_CANCEL",
      text: "Ontario should cancel or pause Highway 413 pending stronger environmental assessment.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.4, polarity: -1 },
        { axis_id: "economic_model", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "ON_STRONG_MAYOR_EXPAND",
      text: "Expanding strong-mayor powers to more municipalities is appropriate to speed housing approvals.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "populism", weight: 0.5, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "ON_STRONG_MAYOR_REPEAL",
      text: "Strong-mayor powers should be rolled back because they harm local democracy without boosting housing results.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "populism", weight: 0.5, polarity: -1 },
        { axis_id: "economic_model", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "ON_ONTP_PLACE_P3",
      text: "The Ontario Place/Therme redevelopment is a worthwhile public-private project.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: 1 },
        { axis_id: "populism", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "ON_ONTP_PLACE_CANCEL",
      text: "The Ontario Place/Therme plan should be scaled back or cancelled in favour of public park and heritage uses.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "ON_GREENBELT_OK",
      text: "The government's Greenbelt land decisions were acceptable and the province has corrected process issues.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.3, polarity: 1 },
        { axis_id: "populism", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "ON_GREENBELT_UNACCEPTABLE",
      text: "The Greenbelt land swap was unacceptable and warrants continued investigation.",
      jurisdiction: "provincial",
      province_gate: ["ON"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.3, polarity: -1 },
        { axis_id: "populism", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "QC_BILL96_PROCEED",
      text: "Bill 96's strengthened French-language requirements for businesses should proceed.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: 1 },
        { axis_id: "federalism", weight: 0.3, polarity: 1 }
      ]
    },
    {
      qid: "QC_BILL96_ROLLBACK",
      text: "Recent expansions to French-language obligations under Bill 96 go too far and should be rolled back.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: -1 },
        { axis_id: "federalism", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "QC_LOWER_IMM_THRESHOLDS",
      text: "Quebec should lower permanent-immigration thresholds to protect French.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "immigration",
      axis_map: [
        { axis_id: "immigration", weight: 0.6, polarity: 1 },
        { axis_id: "social_values", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "QC_MAINTAIN_OR_INCREASE_IMM",
      text: "Quebec should maintain or increase immigration levels to meet labour needs.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "immigration",
      axis_map: [
        { axis_id: "immigration", weight: 0.6, polarity: -1 },
        { axis_id: "economic_model", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "QC_THIRD_LINK_PROCEED",
      text: "The province should pursue a Quebec-Levis 'third link' bridge or tunnel project.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "QC_THIRD_LINK_TO_TRANSIT",
      text: "Funds should be reallocated from the third link to public transit like tramways and REM expansions.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: -1 },
        { axis_id: "economic_model", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "QC_TUITION_HIKE_JUSTIFIED",
      text: "Raising out-of-province university tuition and adding French-proficiency requirements was justified.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "education_childcare",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: 1 },
        { axis_id: "federalism", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "QC_TUITION_HIKE_REVERSE",
      text: "The tuition increase and new French requirements for out-of-province students should be reversed.",
      jurisdiction: "provincial",
      province_gate: ["QC"],
      issue_bucket: "education_childcare",
      axis_map: [
        { axis_id: "social_values", weight: 0.4, polarity: -1 },
        { axis_id: "federalism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NB_RENT_CAP_MAINTAIN",
      text: "New Brunswick should maintain a rent cap to protect tenants.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NB_AVOID_RENT_CAP",
      text: "New Brunswick should avoid rent caps and focus on supply-side incentives for builders.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "NB_POLICY713_NO_PARENTAL_CONSENT",
      text: "Policy 713 should allow informal use of names and pronouns at school without requiring parental consent.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "education_childcare",
      axis_map: [
        { axis_id: "social_values", weight: 0.5, polarity: -1 },
        { axis_id: "civil_liberties", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NB_POLICY713_REQUIRE_PARENTAL",
      text: "Schools should require parental consent for students under 16 to change names or pronouns, even informally.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "education_childcare",
      axis_map: [
        { axis_id: "social_values", weight: 0.5, polarity: 1 },
        { axis_id: "civil_liberties", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "NB_ER_STAFFING",
      text: "Health-care funding should prioritize emergency-room staffing to prevent closures and long waits.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NB_LIMIT_STR",
      text: "Municipalities should have tighter short-term rental rules to free up housing.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NB_PROPERTY_TAX_SHIFT",
      text: "Property tax reform should shift burden away from primary residences toward non-owner-occupied and commercial properties.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "NB_INCREASE_IMM_TARGETS",
      text: "New Brunswick should increase immigration targets tied to housing and health-care workforce needs.",
      jurisdiction: "provincial",
      province_gate: ["NB"],
      issue_bucket: "immigration",
      axis_map: [
        { axis_id: "immigration", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NS_RENT_CAP_EXTEND",
      text: "Nova Scotia's rent cap should be extended to address the housing crunch.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NS_LIFT_RENT_CAP",
      text: "Nova Scotia should lift the rent cap sooner to encourage new rental supply.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "NS_PHYSICIAN_RECRUITMENT",
      text: "Aggressive physician recruitment and faster credential pathways should continue even if costly.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NS_LIMIT_STR",
      text: "Short-term rentals should be limited to boost long-term housing availability.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NS_TAX_CUTS_OVER_HEALTH",
      text: "Nova Scotia should prioritize tax cuts even if that slows health-care hiring.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "NS_RENEWABLES_OVER_GAS",
      text: "Fast-tracking renewable energy and grid upgrades should take precedence over new natural-gas infrastructure.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NS_EXPAND_NP_CLINICS",
      text: "Nova Scotia should expand nurse-practitioner-led clinics across rural areas.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "NS_COMMUNITY_BENEFITS",
      text: "Major projects should include community-benefits agreements for local hiring and training.",
      jurisdiction: "provincial",
      province_gate: ["NS"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.3, polarity: -1 },
        { axis_id: "populism", weight: 0.3, polarity: -1 }
      ]
    },
    {
      qid: "PE_RENT_CAP_MAINTAIN",
      text: "PEI should maintain a rent-increase cap to protect tenants.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "PE_RELAX_RENT_CONTROL",
      text: "PEI should relax rent controls to spur new construction.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "PE_TIGHTEN_STR",
      text: "The province should tighten short-term rental rules to free up year-round housing.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "PE_HEALTH_WORKFORCE_INCENTIVES",
      text: "PEI should prioritize strong incentives for health-worker recruitment and retention.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "PE_SUBSIDIZE_NONPROFIT_HOUSING",
      text: "Provincial programs should more aggressively subsidize non-profit and co-op housing.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "PE_INCREASE_HEALTHCARE_IMM",
      text: "PEI should increase immigration tied to health-care recruitment (e.g., PNP streams).",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "immigration",
      axis_map: [
        { axis_id: "immigration", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "PE_ACTIVE_TRANSPORT_INVEST",
      text: "The province should invest more in active transportation and transit to reduce car dependence.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "PE_ALLOW_GENTLE_DENSITY",
      text: "Land-use rules should permit gentle density (duplexes and fourplexes) in most communities.",
      jurisdiction: "provincial",
      province_gate: ["PE"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NL_ADVANCE_BAY_DU_NORD",
      text: "Newfoundland and Labrador should advance the Bay du Nord offshore project as a jobs and revenue opportunity while managing emissions.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.6, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "NL_PIVOT_FROM_OFFSHORE",
      text: "NL should pivot away from new offshore oil toward renewables and electrification.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "energy_resources",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.7, polarity: -1 }
      ]
    },
    {
      qid: "NL_CHURCHILL_FALLS_FINALIZE",
      text: "The Churchill Falls MOU with Quebec should be finalized along current lines.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "federalism", weight: 0.5, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "NL_CHURCHILL_FALLS_DELAY",
      text: "NL should seek different terms or delay Churchill Falls arrangements until 2041.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "federalism", weight: 0.5, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NL_EXPAND_HOUSING_PROGRAMS",
      text: "The province should expand housing programs like forgivable loans for affordable rentals.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: -1 }
      ]
    },
    {
      qid: "NL_AVOID_BROAD_RENT_CAPS",
      text: "NL should avoid broad rent caps and instead focus on targeted subsidies and new supply.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.6, polarity: 1 }
      ]
    },
    {
      qid: "NL_RATE_MITIGATION",
      text: "Hydro rates should be kept stable via rate mitigation even if it constrains other provincial spending.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "NL_HEALTH_RECRUITMENT",
      text: "The province should increase regional health recruitment incentives such as travel bursaries and locums.",
      jurisdiction: "provincial",
      province_gate: ["NL"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.5, polarity: -1 }
      ]
    },
    {
      qid: "MULTI_AS_OF_RIGHT_MULTIPLEX",
      text: "The province should mandate as-of-right multiplexes (duplex to fourplex) in all urban residential zones.",
      jurisdiction: "provincial",
      province_gate: ["BC","AB","SK","MB","ON","QC","NB","NS","PE","NL"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.4, polarity: -1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    },
    {
      qid: "MULTI_TIGHTEN_RENT_CONTROL",
      text: "Rent control should be tightened even if it discourages some new builds.",
      jurisdiction: "provincial",
      province_gate: ["BC","AB","SK","MB","ON","QC","NB","NS","PE","NL"],
      issue_bucket: "housing",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: -1 }
      ]
    },
    {
      qid: "MULTI_HIGHWAYS_OVER_TRANSIT",
      text: "New highways should be prioritized over new transit in high-growth regions.",
      jurisdiction: "provincial",
      province_gate: ["BC","AB","SK","MB","ON","QC","NB","NS","PE","NL"],
      issue_bucket: "climate_environment",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.5, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "MULTI_PRIVATE_DELIVERY_HEALTH",
      text: "The province should expand private delivery within universal health care (publicly funded).",
      jurisdiction: "provincial",
      province_gate: ["BC","AB","SK","MB","ON","QC","NB","NS","PE","NL"],
      issue_bucket: "healthcare",
      axis_map: [
        { axis_id: "economic_model", weight: 0.7, polarity: 1 }
      ]
    },
    {
      qid: "MULTI_MUNI_PENALTIES_HOUSING",
      text: "Municipalities should be penalized if they fail to meet provincially set housing targets.",
      jurisdiction: "provincial",
      province_gate: ["BC","AB","SK","MB","ON","QC","NB","NS","PE","NL"],
      issue_bucket: "ethics_governance",
      axis_map: [
        { axis_id: "populism", weight: 0.5, polarity: 1 },
        { axis_id: "economic_model", weight: 0.2, polarity: 1 }
      ]
    },
    {
      qid: "MULTI_REDUCE_CARBON_PRICING",
      text: "Carbon pricing should be reduced or paused to address affordability pressures.",
      jurisdiction: "provincial",
      province_gate: ["BC","AB","SK","MB","ON","QC","NB","NS","PE","NL"],
      issue_bucket: "economy_taxes",
      axis_map: [
        { axis_id: "climate_resources", weight: 0.6, polarity: 1 },
        { axis_id: "populism", weight: 0.2, polarity: -1 }
      ]
    }
  ];

  // Filter questions based on jurisdiction and province
  const questions = useMemo(() => {
    return allQuestions.filter(q => {
      if (q.jurisdiction === 'federal') return true;
      if (q.jurisdiction === 'provincial' && q.province_gate) {
        return q.province_gate.includes(province);
      }
      return false;
    });
  }, [province]);

  // Safety check: reset question index if it goes out of bounds
  React.useEffect(() => {
    if (currentQuestionIndex >= questions.length && questions.length > 0) {
      setCurrentQuestionIndex(0);
    }
  }, [questions.length, currentQuestionIndex]);

  // Check for milestones whenever question index changes
  React.useEffect(() => {
    if (screen === 'questions' && questions.length > 0) {
      const prog = ((currentQuestionIndex + 1) / questions.length) * 100;
      
      if (prog >= 25 && prog < 30 && !milestonesShown.has(25)) {
        setMilestonesShown(new Set([...milestonesShown, 25]));
        setMilestoneMessage("25% Complete! You're doing great!");
        setShowMilestone(true);
        setTimeout(() => setShowMilestone(false), 3000);
      } else if (prog >= 50 && prog < 55 && !milestonesShown.has(50)) {
        setMilestonesShown(new Set([...milestonesShown, 50]));
        setMilestoneMessage("Halfway there! Keep up the momentum!");
        setShowMilestone(true);
        setTimeout(() => setShowMilestone(false), 3000);
      } else if (prog >= 75 && prog < 80 && !milestonesShown.has(75)) {
        setMilestonesShown(new Set([...milestonesShown, 75]));
        setMilestoneMessage("75% Done! Almost at the finish line!");
        setShowMilestone(true);
        setTimeout(() => setShowMilestone(false), 3000);
      }
    }
  }, [currentQuestionIndex, screen, questions.length, milestonesShown]);

  const knowledgeQuiz = [
    {
      qid: "K1_INFLATION",
      text: "Inflation primarily refers to:",
      options: [
        "A general increase in prices across the economy",
        "A rise in the price of gasoline only",
        "An increase in wages only",
        "A fall in the value of exports"
      ],
      correct: 0
    },
    {
      qid: "K2_DEFICIT_DEBT",
      text: "The federal budget deficit is:",
      options: [
        "The total amount the government owes",
        "The difference between spending and revenue in a year",
        "The total value of government assets",
        "The central bank's interest rate"
      ],
      correct: 1
    },
    {
      qid: "K3_MARGINAL_TAX",
      text: "A marginal tax rate means:",
      options: [
        "All your income is taxed at the same rate",
        "The tax on the last dollar you earn",
        "A flat fee added to every paycheque",
        "A tax only on capital gains"
      ],
      correct: 1
    }
  ];

  const issueBuckets = [
    { id: "cost_of_living", label: "Cost of Living" },
    { id: "housing", label: "Housing" },
    { id: "healthcare", label: "Healthcare" },
    { id: "climate_environment", label: "Climate & Environment" },
    { id: "energy_resources", label: "Energy & Resources" },
    { id: "economy_taxes", label: "Economy & Taxes" },
    { id: "immigration", label: "Immigration" },
    { id: "indigenous_reconciliation", label: "Indigenous Reconciliation" },
    { id: "civil_liberties_public_safety", label: "Civil Liberties & Public Safety" },
    { id: "foreign_policy_defence", label: "Foreign Policy & Defence" },
    { id: "education_childcare", label: "Education & Childcare" },
    { id: "ethics_governance", label: "Ethics & Governance" }
  ];

  const parties = {
    CPC: { name: "Conservative", color: "#1A4D9C", economic_model: 0.7, social_values: 0.5, climate_resources: 0.6, immigration: 0.2, civil_liberties: 0.3, foreign_defence: 0.5, reconciliation: 0.2, populism: 0.3 },
    LPC: { name: "Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.4, climate_resources: -0.4, immigration: -0.4, civil_liberties: -0.1, foreign_defence: 0.1, reconciliation: -0.3, populism: -0.2 },
    NDP: { name: "NDP", color: "#F37021", economic_model: -0.7, social_values: -0.6, climate_resources: -0.6, immigration: -0.5, civil_liberties: -0.2, foreign_defence: -0.2, reconciliation: -0.6, populism: -0.1 },
    GPC: { name: "Green", color: "#3D9B35", economic_model: -0.5, social_values: -0.5, climate_resources: -0.8, immigration: -0.4, civil_liberties: -0.2, foreign_defence: -0.1, reconciliation: -0.6, populism: -0.2 },
    BQ: { name: "Bloc", color: "#33B2CC", economic_model: -0.1, social_values: -0.2, climate_resources: -0.2, immigration: -0.1, civil_liberties: 0.0, foreign_defence: 0.0, reconciliation: -0.3, populism: -0.1 },
    PPC: { name: "PPC", color: "#4B3D8F", economic_model: 0.8, social_values: 0.8, climate_resources: 0.9, immigration: 0.8, civil_liberties: 0.4, foreign_defence: 0.2, reconciliation: 0.4, populism: 0.8 }
  };

  const provincialParties = {
    BC: {
      BCNDP: { name: "BC NDP", color: "#F37021", economic_model: -0.7, social_values: -0.5, climate_resources: -0.6, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 },
      BCCONS: { name: "BC Conservative", color: "#1A4D9C", economic_model: 0.7, social_values: 0.6, climate_resources: 0.6, immigration: 0.3, civil_liberties: 0.3, reconciliation: 0.2, populism: 0.4, foreign_defence: 0.0 },
      BCGREEN: { name: "BC Green", color: "#3D9B35", economic_model: -0.5, social_values: -0.5, climate_resources: -0.8, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.2, foreign_defence: 0.0 },
      BCUNITED: { name: "BC United", color: "#0066CC", economic_model: 0.3, social_values: 0.1, climate_resources: 0.2, immigration: -0.1, civil_liberties: 0.0, reconciliation: -0.1, populism: 0.0, foreign_defence: 0.0 }
    },
    AB: {
      UCP: { name: "United Conservative", color: "#1A4D9C", economic_model: 0.8, social_values: 0.6, climate_resources: 0.7, immigration: 0.3, civil_liberties: 0.3, reconciliation: 0.2, populism: 0.4, foreign_defence: 0.0 },
      ABNDP: { name: "Alberta NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 }
    },
    SK: {
      SKPARTY: { name: "Saskatchewan Party", color: "#00843D", economic_model: 0.6, social_values: 0.4, climate_resources: 0.5, immigration: 0.2, civil_liberties: 0.2, reconciliation: 0.1, populism: 0.2, foreign_defence: 0.0 },
      SKNDP: { name: "Saskatchewan NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 }
    },
    MB: {
      MBPC: { name: "Manitoba PC", color: "#1A4D9C", economic_model: 0.6, social_values: 0.4, climate_resources: 0.4, immigration: 0.1, civil_liberties: 0.2, reconciliation: 0.1, populism: 0.2, foreign_defence: 0.0 },
      MBNDP: { name: "Manitoba NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 },
      MBLIB: { name: "Manitoba Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.3, climate_resources: -0.3, immigration: -0.3, civil_liberties: -0.1, reconciliation: -0.3, populism: -0.2, foreign_defence: 0.0 }
    },
    ON: {
      ONPC: { name: "Ontario PC", color: "#1A4D9C", economic_model: 0.6, social_values: 0.3, climate_resources: 0.4, immigration: 0.1, civil_liberties: 0.2, reconciliation: 0.1, populism: 0.3, foreign_defence: 0.0 },
      ONLIB: { name: "Ontario Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.4, climate_resources: -0.3, immigration: -0.3, civil_liberties: -0.1, reconciliation: -0.3, populism: -0.2, foreign_defence: 0.0 },
      ONNDP: { name: "Ontario NDP", color: "#F37021", economic_model: -0.7, social_values: -0.6, climate_resources: -0.6, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 },
      ONGREEN: { name: "Ontario Green", color: "#3D9B35", economic_model: -0.5, social_values: -0.5, climate_resources: -0.8, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.2, foreign_defence: 0.0 }
    },
    QC: {
      CAQ: { name: "CAQ", color: "#00AADD", economic_model: 0.3, social_values: 0.3, climate_resources: 0.1, immigration: 0.3, civil_liberties: 0.2, reconciliation: 0.0, populism: 0.3, foreign_defence: 0.0 },
      PLQ: { name: "PLQ", color: "#D71920", economic_model: -0.1, social_values: -0.3, climate_resources: -0.2, immigration: -0.3, civil_liberties: -0.1, reconciliation: -0.2, populism: -0.2, foreign_defence: 0.0 },
      PQ: { name: "PQ", color: "#004B87", economic_model: -0.3, social_values: -0.1, climate_resources: -0.3, immigration: 0.0, civil_liberties: 0.0, reconciliation: -0.2, populism: 0.1, foreign_defence: 0.0 },
      QS: { name: "Quebec Solidaire", color: "#FF5607", economic_model: -0.8, social_values: -0.7, climate_resources: -0.7, immigration: -0.5, civil_liberties: -0.3, reconciliation: -0.6, populism: -0.2, foreign_defence: 0.0 },
      PCQ: { name: "Conservative Party", color: "#1A4D9C", economic_model: 0.7, social_values: 0.7, climate_resources: 0.6, immigration: 0.5, civil_liberties: 0.4, reconciliation: 0.2, populism: 0.6, foreign_defence: 0.0 }
    },
    NB: {
      NBPC: { name: "NB PC", color: "#1A4D9C", economic_model: 0.5, social_values: 0.3, climate_resources: 0.3, immigration: 0.1, civil_liberties: 0.2, reconciliation: 0.0, populism: 0.2, foreign_defence: 0.0 },
      NBLIB: { name: "NB Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.3, climate_resources: -0.3, immigration: -0.2, civil_liberties: -0.1, reconciliation: -0.2, populism: -0.1, foreign_defence: 0.0 },
      NBGREEN: { name: "NB Green", color: "#3D9B35", economic_model: -0.4, social_values: -0.4, climate_resources: -0.7, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.4, populism: -0.2, foreign_defence: 0.0 },
      NBNDP: { name: "NB NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.6, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 }
    },
    NS: {
      NSPC: { name: "NS PC", color: "#1A4D9C", economic_model: 0.5, social_values: 0.3, climate_resources: 0.3, immigration: 0.1, civil_liberties: 0.2, reconciliation: 0.0, populism: 0.2, foreign_defence: 0.0 },
      NSLIB: { name: "NS Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.3, climate_resources: -0.3, immigration: -0.2, civil_liberties: -0.1, reconciliation: -0.2, populism: -0.1, foreign_defence: 0.0 },
      NSNDP: { name: "NS NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 },
      NSGREEN: { name: "NS Green", color: "#3D9B35", economic_model: -0.4, social_values: -0.4, climate_resources: -0.7, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.4, populism: -0.2, foreign_defence: 0.0 }
    },
    PE: {
      PEPC: { name: "PEI PC", color: "#1A4D9C", economic_model: 0.5, social_values: 0.3, climate_resources: 0.2, immigration: 0.1, civil_liberties: 0.2, reconciliation: 0.0, populism: 0.2, foreign_defence: 0.0 },
      PELIB: { name: "PEI Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.3, climate_resources: -0.3, immigration: -0.2, civil_liberties: -0.1, reconciliation: -0.2, populism: -0.1, foreign_defence: 0.0 },
      PEGREEN: { name: "PEI Green", color: "#3D9B35", economic_model: -0.4, social_values: -0.4, climate_resources: -0.7, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.4, populism: -0.2, foreign_defence: 0.0 },
      PENDP: { name: "PEI NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 }
    },
    NL: {
      NLPC: { name: "NL PC", color: "#1A4D9C", economic_model: 0.5, social_values: 0.3, climate_resources: 0.4, immigration: 0.1, civil_liberties: 0.2, reconciliation: 0.0, populism: 0.2, foreign_defence: 0.0 },
      NLLIB: { name: "NL Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.3, climate_resources: -0.2, immigration: -0.2, civil_liberties: -0.1, reconciliation: -0.2, populism: -0.1, foreign_defence: 0.0 },
      NLNDP: { name: "NL NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.4, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 }
    },
    YT: {
      YTYUKON: { name: "Yukon Party", color: "#005CA9", economic_model: 0.4, social_values: 0.2, climate_resources: 0.3, immigration: 0.0, civil_liberties: 0.1, reconciliation: 0.0, populism: 0.1, foreign_defence: 0.0 },
      YTLIB: { name: "Yukon Liberal", color: "#D71920", economic_model: -0.2, social_values: -0.3, climate_resources: -0.3, immigration: -0.2, civil_liberties: -0.1, reconciliation: -0.3, populism: -0.1, foreign_defence: 0.0 },
      YTNDP: { name: "Yukon NDP", color: "#F37021", economic_model: -0.6, social_values: -0.5, climate_resources: -0.5, immigration: -0.3, civil_liberties: -0.2, reconciliation: -0.5, populism: -0.1, foreign_defence: 0.0 }
    },
    NT: {},
    NU: {}
  };

  const calculateResults = () => {
    const axisScores = {};
    const axisWeights = {};
    const federalAxisScores = {};
    const federalAxisWeights = {};
    const provincialAxisScores = {};
    const provincialAxisWeights = {};
    
    // Initialize
    Object.keys(parties.CPC).forEach(axis => {
      if (axis !== 'name' && axis !== 'color') {
        axisScores[axis] = 0;
        axisWeights[axis] = 0;
        federalAxisScores[axis] = 0;
        federalAxisWeights[axis] = 0;
        provincialAxisScores[axis] = 0;
        provincialAxisWeights[axis] = 0;
      }
    });

    // Calculate raw scores
    questions.forEach(q => {
      const response = responses[q.qid];
      if (response !== undefined && response !== null) {
        const value = (response - 50) / 50;
        const importanceMultiplier = questionImportance[q.qid] ? 1.5 : 1.0;
        
        q.axis_map.forEach(mapping => {
          const contribution = value * mapping.weight * mapping.polarity * importanceMultiplier;
          axisScores[mapping.axis_id] += contribution;
          axisWeights[mapping.axis_id] += Math.abs(mapping.weight) * importanceMultiplier;
          
          if (q.jurisdiction === 'federal') {
            federalAxisScores[mapping.axis_id] += contribution;
            federalAxisWeights[mapping.axis_id] += Math.abs(mapping.weight) * importanceMultiplier;
          } else if (q.jurisdiction === 'provincial') {
            provincialAxisScores[mapping.axis_id] += contribution;
            provincialAxisWeights[mapping.axis_id] += Math.abs(mapping.weight) * importanceMultiplier;
          }
        });
      }
    });

    // Normalize
    Object.keys(axisScores).forEach(axis => {
      if (axisWeights[axis] > 0) {
        axisScores[axis] = axisScores[axis] / axisWeights[axis];
      }
      if (federalAxisWeights[axis] > 0) {
        federalAxisScores[axis] = federalAxisScores[axis] / federalAxisWeights[axis];
      }
      if (provincialAxisWeights[axis] > 0) {
        provincialAxisScores[axis] = provincialAxisScores[axis] / provincialAxisWeights[axis];
      }
    });

    // Calculate federal party distances
    const partyDistances = {};
    Object.entries(parties).forEach(([code, party]) => {
      let sumSquares = 0;
      let count = 0;
      const axisDetails = {};
      
      Object.keys(federalAxisScores).forEach(axis => {
        if (party[axis] !== undefined) {
          const diff = federalAxisScores[axis] - party[axis];
          sumSquares += Math.pow(diff, 2);
          axisDetails[axis] = {
            yourScore: federalAxisScores[axis],
            partyScore: party[axis],
            difference: Math.abs(diff)
          };
          count++;
        }
      });
      
      const distance = Math.sqrt(sumSquares / count);
      partyDistances[code] = {
        distance,
        alignment: Math.max(0, (1 - distance / 2) * 100),
        axisDetails
      };
    });

    // Calculate provincial party distances
    const provincialPartyDistances = {};
    const provParties = provincialParties[province] || {};
    Object.entries(provParties).forEach(([code, party]) => {
      let sumSquares = 0;
      let count = 0;
      const axisDetails = {};
      
      Object.keys(provincialAxisScores).forEach(axis => {
        if (party[axis] !== undefined) {
          const diff = provincialAxisScores[axis] - party[axis];
          sumSquares += Math.pow(diff, 2);
          axisDetails[axis] = {
            yourScore: provincialAxisScores[axis],
            partyScore: party[axis],
            difference: Math.abs(diff)
          };
          count++;
        }
      });
      
      if (count > 0) {
        const distance = Math.sqrt(sumSquares / count);
        provincialPartyDistances[code] = {
          distance,
          alignment: Math.max(0, (1 - distance / 2) * 100),
          axisDetails
        };
      }
    });

    // Calculate confidence
    const totalQuestions = questions.length;
    const neutralCount = Object.values(responses).filter(r => r === 50).length;
    const knowledgeCorrect = Object.entries(knowledgeAnswers).filter(([qid, ans]) => {
      const q = knowledgeQuiz.find(kq => kq.qid === qid);
      return q && ans === q.correct;
    }).length;
    const knowledgeRate = knowledgeQuiz.length > 0 ? knowledgeCorrect / knowledgeQuiz.length : 1;
    
    let confidence = 'high';
    if (neutralCount / totalQuestions > 0.5 || knowledgeRate < 0.375) {
      confidence = 'low';
    } else if (neutralCount / totalQuestions > 0.3 || knowledgeRate < 0.6) {
      confidence = 'medium';
    }

    // Consistency check
    const consistencyIssues = [];
    if (responses['ECON_PROGRESSIVE_TAX'] <= 20 && responses['ECON_BALANCED_BUDGETS'] >= 80) {
      consistencyIssues.push("You strongly support both higher taxes for social programs and balanced budgets - these may be in tension.");
    }
    if (responses['CONT_US_POLITICAL_INFLUENCE'] >= 80 && responses['CONT_US_MEDIA_REGULATION'] <= 20) {
      consistencyIssues.push("You strongly agree US influence is a problem but strongly oppose regulating US political content - how would you address the concern?");
    }

    return { axisScores, partyDistances, provincialPartyDistances, confidence, consistencyIssues };
  };

  const ConsentScreen = () => {
    const submitAnonymizedData = async () => {
      if (!consentToShare) {
        setScreen('results');
        return;
      }

      const { axisScores, partyDistances } = calculateResults();
      
      const anonymizedData = {
        timestamp: new Date().toISOString(),
        province: province,
        responses: responses,
        questionImportance: questionImportance,
        importanceWeights: importance,
        knowledgeAnswers: knowledgeAnswers,
        pastVote2021: pastVote2021,
        axisScores: axisScores,
        topThreeParties: Object.entries(partyDistances)
          .sort((a, b) => b[1].alignment - a[1].alignment)
          .slice(0, 3)
          .map(([code, data]) => ({ party: code, alignment: data.alignment }))
      };

      try {
        const response = await fetch('https://hook.us1.make.com/your-webhook-id-here', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(anonymizedData)
        });

        if (response.ok) {
          setDataSubmitted(true);
        }
      } catch (error) {
        console.error('Error submitting data:', error);
      }

      setScreen('results');
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 flex items-center justify-center p-4">
        <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl p-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-4">Help Improve Canadian Political Research</h2>
          
          <div className="space-y-4 mb-6 text-gray-700">
            <p className="text-lg">
              You've completed the survey! Before we show your results, would you like to contribute your anonymized responses to help improve political research in Canada?
            </p>

            <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
              <h3 className="font-bold text-blue-900 mb-2">What WILL be collected (if you consent):</h3>
              <ul className="list-disc list-inside space-y-1 text-sm text-blue-900">
                <li>Your province</li>
                <li>Your responses to all survey questions</li>
                <li>Which questions you marked as important</li>
                <li>Your priority issue rankings</li>
                <li>Your knowledge quiz responses</li>
                <li>Your past voting behavior (2021)</li>
                <li>Your calculated political positioning</li>
                <li>Timestamp of submission</li>
              </ul>
            </div>

            <div className="bg-green-50 border-l-4 border-green-600 p-4 rounded">
              <h3 className="font-bold text-green-900 mb-2">What will NOT be collected:</h3>
              <ul className="list-disc list-inside space-y-1 text-sm text-green-900">
                <li>No IP addresses</li>
                <li>No email addresses or names</li>
                <li>No device identifiers or fingerprints</li>
                <li>No cookies or tracking pixels</li>
                <li>No session IDs that could identify you</li>
                <li>No personally identifiable information of any kind</li>
              </ul>
            </div>
          </div>

          <div className="mb-6 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
            <label className="flex items-start gap-3 cursor-pointer">
              <input
                type="checkbox"
                checked={consentToShare}
                onChange={(e) => setConsentToShare(e.target.checked)}
                className="mt-1 w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-500"
              />
              <span className="text-gray-900 font-medium">
                I consent to sharing my anonymized survey responses for research purposes as described above. 
                I understand that no personally identifiable information will be collected.
              </span>
            </label>
          </div>

          <div className="flex gap-4">
            <button
              onClick={() => {
                setConsentToShare(false);
                setScreen('results');
              }}
              className="flex-1 py-4 px-6 border-2 border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-semibold transition-colors"
            >
              No Thanks, Show My Results
            </button>
            <button
              onClick={submitAnonymizedData}
              className={`flex-1 py-4 px-6 rounded-lg font-semibold transition-colors ${
                consentToShare
                  ? 'bg-red-600 hover:bg-red-700 text-white'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              {consentToShare ? 'Submit & See Results' : 'Please Check Box Above'}
            </button>
          </div>
        </div>
      </div>
    );
  };

  const scaleLabels = ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"];
  const scaleValues = [-1, -0.5, 0, 0.5, 1];

  const WelcomeScreen = () => (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 flex items-center justify-center p-4">
      <div className="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8 md:p-12">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">Canadian Vote Spectrum</h1>
          <p className="text-lg text-gray-600">Discover where you stand on the Canadian political spectrum</p>
        </div>
        
        <div className="space-y-4 mb-8 text-gray-700">
          <p>This comprehensive voting advice instrument will help you understand your political positioning across multiple dimensions including economic policy, social values, climate priorities, and more.</p>
          
          <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
            <p className="font-semibold mb-2">What to expect:</p>
            <ul className="space-y-1 text-sm">
              <li>36 federal policy questions including current events & controversial issues</li>
              <li>Up to 12 province-specific questions</li>
              <li>Mark questions as very important for personalized weighting</li>
              <li>Educational facts about Canadian politics</li>
              <li>Progress milestones to keep you motivated</li>
              <li>Priority weighting exercise across 12 issue areas</li>
              <li>3 knowledge check questions</li>
              <li>Detailed breakdown showing WHY you matched with each party</li>
              <li>Consistency analysis of your responses</li>
              <li>Personalized results with party alignment & 2D positioning</li>
            </ul>
          </div>
          
          <p className="text-sm text-gray-600">
            <strong>Time estimate:</strong> 15-20 minutes
            <strong className="ml-2">Privacy:</strong> Your responses are private and never tracked. 
            At the end, you can optionally contribute anonymized data for research.
          </p>
        </div>
        
        <button
          onClick={() => setScreen('province')}
          className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200 shadow-lg"
        >
          Get Started
        </button>
      </div>
    </div>
  );

  const ProvinceScreen = () => (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 flex items-center justify-center p-4">
      <div className="max-w-xl w-full bg-white rounded-2xl shadow-xl p-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-6">Select Your Province</h2>
        <p className="text-gray-600 mb-6">This helps us show you relevant provincial questions.</p>
        
        <div className="grid grid-cols-2 gap-3">
          {['BC', 'AB', 'SK', 'MB', 'ON', 'QC', 'NB', 'NS', 'PE', 'NL', 'YT', 'NT', 'NU'].map(prov => (
            <button
              key={prov}
              onClick={() => {
                setProvince(prov);
                setScreen('past-vote');
              }}
              className="py-3 px-4 border-2 border-gray-200 hover:border-red-600 hover:bg-red-50 rounded-lg font-medium transition-all duration-200"
            >
              {prov}
            </button>
          ))}
        </div>
      </div>
    </div>
  );

  const PastVoteScreen = () => (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 flex items-center justify-center p-4">
      <div className="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-4">One More Question</h2>
        <p className="text-gray-600 mb-6">
          This helps us calibrate your results more accurately.
        </p>
        
        <div className="mb-6">
          <label className="block text-lg font-semibold text-gray-900 mb-4">
            Which party did you vote for in the 2021 federal election? (Optional)
          </label>
          <div className="space-y-3">
            {['Liberal', 'Conservative', 'NDP', 'Bloc Quebecois', 'Green', 'PPC', 'Other/Did not vote', 'Prefer not to say'].map(party => (
              <button
                key={party}
                onClick={() => {
                  setPastVote2021(party);
                }}
                className={`w-full py-3 px-6 rounded-lg border-2 transition-all duration-200 text-left font-medium ${
                  pastVote2021 === party
                    ? 'border-red-600 bg-red-50 text-red-900'
                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                }`}
              >
                {party}
              </button>
            ))}
          </div>
        </div>

        <button
          onClick={() => {
            setCurrentQuestionIndex(0);
            setScreen('questions');
          }}
          className="w-full py-4 px-6 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors"
        >
          Continue to Questions
        </button>
      </div>
    </div>
  );

  const QuestionsScreen = () => {
    if (questions.length === 0 || currentQuestionIndex >= questions.length) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
            <p className="text-xl text-gray-900 mb-4">Loading questions...</p>
            <button
              onClick={() => {
                setCurrentQuestionIndex(0);
                setScreen('province');
              }}
              className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold"
            >
              Restart
            </button>
          </div>
        </div>
      );
    }

    const q = questions[currentQuestionIndex];
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    const isImportant = questionImportance[q.qid] || false;
    const currentValue = responses[q.qid] !== undefined ? responses[q.qid] : 50;

    const getLabel = (value) => {
      if (value <= 10) return "Strongly Disagree";
      if (value <= 35) return "Disagree";
      if (value <= 65) return "Neutral";
      if (value <= 90) return "Agree";
      return "Strongly Agree";
    };

    const didYouKnowFacts = [
      "Canada has had 23 Prime Ministers since Confederation in 1867.",
      "The longest-serving PM was William Lyon Mackenzie King (21 years).",
      "Canada's Senate has 105 appointed members who serve until age 75.",
      "The Bloc Quebecois only runs candidates in Quebec ridings.",
      "Canada uses a first-past-the-post electoral system.",
      "Federal elections must be held at least every 5 years.",
      "The Governor General formally appoints the Prime Minister.",
      "Quebec has 78 federal seats, the second-most after Ontario's 121.",
      "A party needs 172 seats to form a majority government in Canada's 343-seat House of Commons.",
      "Canada held a referendum on electoral reform in British Columbia in 2018 - it was defeated.",
      "The Clarity Act (2000) sets conditions for Quebec separation referendums.",
      "Supply management has protected Canadian dairy farmers since the 1970s.",
      "Canada's current voting system was established in 1867 and has never changed.",
      "The notwithstanding clause has been used over 50 times by provincial governments.",
      "About 75% of Canadians live within 100 miles of the US border.",
      "Canada-US trade exceeds $900 billion annually, making it the world's largest bilateral trade relationship.",
      "The US accounts for about 75% of Canada's total exports.",
      "CRTC regulations require Canadian radio stations to play at least 35% Canadian content."
    ];
    const randomFact = didYouKnowFacts[currentQuestionIndex % didYouKnowFacts.length];

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 p-4 py-8">
        <div className="max-w-3xl mx-auto">
          <div className="mb-6">
            <div className="flex justify-between text-sm text-gray-600 mb-2">
              <span>Question {currentQuestionIndex + 1} of {questions.length}</span>
              <span>{Math.round(progress)}% Complete</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div 
                className="bg-red-600 h-2 rounded-full transition-all duration-300"
                style={{ width: `${progress}%` }}
              />
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow-xl p-8 relative" style={{ height: '900px' }}>
            <div className="h-[800px] overflow-y-auto">
              <div className="mb-8 h-[16rem]">
                <div className="flex gap-2 mb-4">
                  <span className="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
                    {q.issue_bucket.replace(/_/g, ' ').toUpperCase()}
                  </span>
                  {q.jurisdiction === 'provincial' && (
                    <span className="inline-block px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full">
                      {province} PROVINCIAL
                    </span>
                  )}
                </div>
                <h3 className="text-2xl font-bold text-gray-900 mb-4 h-[10rem] flex items-start overflow-y-auto">{q.text}</h3>
                
                <div className="flex items-center justify-between mb-4">
                  <button
                    onClick={() => setQuestionImportance({ ...questionImportance, [q.qid]: !isImportant })}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg border-2 transition-all duration-200 ${
                      isImportant
                        ? 'border-yellow-500 bg-yellow-50 text-yellow-800'
                        : 'border-gray-300 text-gray-600 hover:border-yellow-400'
                    }`}
                  >
                    <svg className="w-5 h-5" fill={isImportant ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    {isImportant ? 'Very Important to Me' : 'Mark as Important'}
                  </button>
                </div>
              </div>

              <div className="space-y-6 h-[420px]">
                <div className="text-center">
                  <div className="inline-block px-6 py-3 bg-red-600 text-white rounded-full text-xl font-bold mb-2">
                    {getLabel(currentValue)}
                  </div>
                  <div className="text-sm text-gray-500">
                    Position: {currentValue}
                  </div>
                </div>

                <div className="px-2">
                  <input
                    type="range"
                    min="0"
                    max="100"
                    step="1"
                    value={currentValue}
                    onChange={(e) => {
                      const newValue = Number(e.target.value);
                      setResponses({ ...responses, [q.qid]: newValue });
                    }}
                    className="w-full h-3 bg-gradient-to-r from-red-600 via-gray-300 to-blue-600 rounded-lg appearance-none cursor-pointer slider"
                    style={{
                      background: `linear-gradient(to right, #DC2626 0%, #EF4444 20%, #D1D5DB 40%, #D1D5DB 60%, #3B82F6 80%, #2563EB 100%)`
                    }}
                  />
                  <style>{`
                    .slider::-webkit-slider-thumb {
                      appearance: none;
                      width: 32px;
                      height: 32px;
                      border-radius: 50%;
                      background: white;
                      border: 4px solid #DC2626;
                      cursor: pointer;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    }
                    .slider::-webkit-slider-thumb:hover {
                      transform: scale(1.15);
                      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                    }
                    .slider::-webkit-slider-thumb:active {
                      transform: scale(1.05);
                    }
                    .slider::-moz-range-thumb {
                      width: 32px;
                      height: 32px;
                      border-radius: 50%;
                      background: white;
                      border: 4px solid #DC2626;
                      cursor: pointer;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    }
                    .slider::-moz-range-thumb:hover {
                      transform: scale(1.15);
                      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                    }
                    .slider::-moz-range-thumb:active {
                      transform: scale(1.05);
                    }
                  `}</style>
                </div>

                <div className="flex justify-between text-xs text-gray-600 px-2">
                  <span className="font-semibold">Strongly<br/>Disagree</span>
                  <span className="font-semibold">Disagree</span>
                  <span className="font-semibold">Neutral</span>
                  <span className="font-semibold">Agree</span>
                  <span className="font-semibold">Strongly<br/>Agree</span>
                </div>

                <div className="grid grid-cols-5 gap-2 mt-4">
                  {[
                    { value: 0, label: "SD" },
                    { value: 25, label: "D" },
                    { value: 50, label: "N" },
                    { value: 75, label: "A" },
                    { value: 100, label: "SA" }
                  ].map((option) => (
                    <button
                      key={option.value}
                      onClick={() => {
                        setResponses({ ...responses, [q.qid]: option.value });
                      }}
                      className={`py-2 px-3 rounded-lg border-2 font-semibold text-sm transition-all duration-200 ${
                        Math.abs(currentValue - option.value) <= 12
                          ? 'border-red-600 bg-red-50 text-red-900'
                          : 'border-gray-200 hover:border-gray-400 text-gray-600'
                      }`}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>

              <div className={`p-3 mt-6 h-[4rem] flex items-center overflow-y-auto rounded-lg border-l-4 ${
                showMilestone 
                  ? 'bg-green-100 border-green-600' 
                  : 'bg-blue-50 border-blue-500'
              }`}>
                {showMilestone ? (
                  <p className="text-sm text-green-900 font-bold animate-pulse">
                    {milestoneMessage}
                  </p>
                ) : (
                  <p className="text-sm text-blue-900">
                    <strong>Did you know?</strong> {randomFact}
                  </p>
                )}
              </div>
            </div>

            <div className="absolute bottom-8 left-8 right-8 flex gap-3">
              {currentQuestionIndex > 0 && (
                <button
                  onClick={() => setCurrentQuestionIndex(currentQuestionIndex - 1)}
                  className="px-6 py-2 border-2 border-gray-300 hover:bg-gray-50 rounded-lg font-medium transition-colors"
                >
                  Previous
                </button>
              )}
              <div className="flex gap-3 ml-auto">
                <button
                  onClick={() => {
                    if (currentQuestionIndex < questions.length - 1) {
                      setCurrentQuestionIndex(currentQuestionIndex + 1);
                    } else {
                      setScreen('importance');
                    }
                  }}
                  className="px-6 py-2 border-2 border-gray-300 hover:bg-gray-50 rounded-lg font-medium transition-colors"
                >
                  Skip
                </button>
                {responses[q.qid] !== undefined && (
                  <button
                    onClick={() => {
                      if (currentQuestionIndex < questions.length - 1) {
                        setCurrentQuestionIndex(currentQuestionIndex + 1);
                      } else {
                        setScreen('importance');
                      }
                    }}
                    className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors"
                  >
                    {currentQuestionIndex < questions.length - 1 ? 'Next' : 'Continue'}
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const ImportanceScreen = () => {
    const remaining = 100 - Object.values(importance).reduce((sum, val) => sum + val, 0);
    
    const sortedBuckets = [...issueBuckets].sort((a, b) => {
      const aVal = importance[a.id] || 0;
      const bVal = importance[b.id] || 0;
      return bVal - aVal;
    });

    const incrementValue = (id, amount) => {
      const currentVal = importance[id] || 0;
      const newVal = Math.max(0, Math.min(100, currentVal + amount));
      const diff = newVal - currentVal;
      
      if (diff > 0 && remaining >= diff) {
        setImportance({ ...importance, [id]: newVal });
      } else if (diff < 0) {
        setImportance({ ...importance, [id]: newVal });
      }
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 p-4 py-8">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-3xl font-bold text-gray-900 mb-4">What Matters Most to You?</h2>
            <p className="text-gray-600 mb-6">
              Distribute 100 points across these issues. Give more points to issues that are most important to you.
              Your priorities will personalize your results.
            </p>

            <div className="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="col-span-1 md:col-span-2 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200">
                <div className="text-sm text-blue-800 font-semibold mb-1">POINTS REMAINING</div>
                <div className="text-5xl font-bold text-blue-900">{remaining}</div>
              </div>
              
              <div className="flex flex-col gap-2">
                <button
                  onClick={() => {
                    const equalPoints = Math.floor(100 / issueBuckets.length);
                    const newImportance = {};
                    issueBuckets.forEach((bucket, idx) => {
                      newImportance[bucket.id] = idx === 0 ? equalPoints + (100 - equalPoints * issueBuckets.length) : equalPoints;
                    });
                    setImportance(newImportance);
                  }}
                  className="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors"
                >
                  Distribute Equally
                </button>
                <button
                  onClick={() => setImportance({})}
                  className="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold rounded-lg transition-colors"
                >
                  Clear All
                </button>
              </div>
            </div>

            <div className="space-y-3 mb-8">
              {sortedBuckets.map((bucket, index) => {
                const value = importance[bucket.id] || 0;
                const barWidth = value;
                
                return (
                  <div key={bucket.id} className="group">
                    <div className="flex items-center gap-3 mb-2">
                      <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                        value > 0 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-600'
                      }`}>
                        {index + 1}
                      </div>
                      <div className="flex-1">
                        <label className="font-semibold text-gray-900">{bucket.label}</label>
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => incrementValue(bucket.id, -5)}
                          disabled={value === 0}
                          className="w-8 h-8 flex items-center justify-center bg-gray-200 hover:bg-gray-300 disabled:opacity-30 disabled:cursor-not-allowed rounded-lg font-bold text-gray-700 transition-colors"
                        >
                          −
                        </button>
                        <div className="w-16 text-center">
                          <span className="text-2xl font-bold text-red-600">{value}</span>
                        </div>
                        <button
                          onClick={() => incrementValue(bucket.id, 5)}
                          disabled={remaining < 5}
                          className="w-8 h-8 flex items-center justify-center bg-red-600 hover:bg-red-700 disabled:opacity-30 disabled:cursor-not-allowed text-white rounded-lg font-bold transition-colors"
                        >
                          +
                        </button>
                      </div>
                    </div>
                    <div className="ml-11 relative">
                      <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div
                          className="bg-gradient-to-r from-red-500 to-red-600 h-3 rounded-full transition-all duration-300 ease-out"
                          style={{ width: `${barWidth}%` }}
                        />
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-6">
              <p className="text-sm text-yellow-900">
                <strong>Tip:</strong> You don't need to use all 100 points. Only allocate points to issues that matter to you. 
                Unallocated points mean those issues won't affect your results as much.
              </p>
            </div>

            <button
              onClick={() => setScreen('knowledge')}
              disabled={remaining !== 0}
              className={`w-full py-4 px-6 rounded-lg font-semibold transition-all duration-200 ${
                remaining === 0
                  ? 'bg-red-600 hover:bg-red-700 text-white shadow-lg'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              {remaining === 0 ? 'Continue to Knowledge Check' : `Allocate ${remaining} more points to continue`}
            </button>
          </div>
        </div>
      </div>
    );
  };

  const KnowledgeScreen = () => {
    const [currentQ, setCurrentQ] = useState(0);
    const q = knowledgeQuiz[currentQ];
    const currentAnswer = knowledgeAnswers[q.qid];

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 p-4 py-8">
        <div className="max-w-3xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <div className="mb-6">
              <span className="inline-block px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full mb-4">
                KNOWLEDGE CHECK {currentQ + 1} of {knowledgeQuiz.length}
              </span>
              <h3 className="text-2xl font-bold text-gray-900 mb-4">{q.text}</h3>
            </div>

            <div className="space-y-3">
              {q.options.map((option, idx) => (
                <button
                  key={idx}
                  onClick={() => {
                    const newAnswers = { ...knowledgeAnswers, [q.qid]: idx };
                    setKnowledgeAnswers(newAnswers);
                  }}
                  className={`w-full py-4 px-6 rounded-lg border-2 transition-all duration-200 text-left font-medium ${
                    currentAnswer === idx
                      ? 'border-purple-600 bg-purple-50 text-purple-900'
                      : 'border-gray-200 hover:border-purple-300 hover:bg-purple-50'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                      currentAnswer === idx
                        ? 'border-purple-600 bg-purple-600'
                        : 'border-gray-300'
                    }`}>
                      {currentAnswer === idx && (
                        <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      )}
                    </div>
                    <span>{option}</span>
                  </div>
                </button>
              ))}
            </div>

            <div className="mt-6 flex gap-3 justify-end">
              <button
                onClick={() => {
                  if (currentQ < knowledgeQuiz.length - 1) {
                    setCurrentQ(currentQ + 1);
                  } else {
                    setScreen('consent');
                  }
                }}
                className="px-6 py-2 border-2 border-gray-300 hover:bg-gray-50 rounded-lg font-medium transition-colors"
              >
                Skip
              </button>
              {currentAnswer !== undefined && (
                <button
                  onClick={() => {
                    if (currentQ < knowledgeQuiz.length - 1) {
                      setCurrentQ(currentQ + 1);
                    } else {
                      setScreen('consent');
                    }
                  }}
                  className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors"
                >
                  {currentQ < knowledgeQuiz.length - 1 ? 'Next' : 'Continue'}
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const ResultsScreen = () => {
    const { axisScores, partyDistances, provincialPartyDistances, confidence, consistencyIssues } = calculateResults();
    
    const federalQs = questions.filter(q => q.jurisdiction === 'federal').length;
    const provincialQs = questions.filter(q => q.jurisdiction === 'provincial').length;
    
    const sortedParties = Object.entries(partyDistances)
      .sort((a, b) => b[1].alignment - a[1].alignment)
      .map(([code, data]) => ({
        code,
        name: parties[code].name,
        alignment: data.alignment,
        color: parties[code].color
      }));

    const sortedProvincialParties = Object.entries(provincialPartyDistances)
      .sort((a, b) => b[1].alignment - a[1].alignment)
      .map(([code, data]) => ({
        code,
        name: provincialParties[province][code].name,
        alignment: data.alignment,
        color: provincialParties[province][code].color
      }));

    const scatterData = [
      {
        name: 'You',
        x: axisScores.economic_model || 0,
        y: axisScores.social_values || 0,
        z: 20,
        color: '#EF4444'
      },
      ...Object.entries(parties).map(([code, party]) => ({
        name: party.name,
        x: party.economic_model,
        y: party.social_values,
        z: 15,
        color: party.color
      }))
    ];

    const pastVoteNote = pastVote2021 && !pastVote2021.includes('not') && !pastVote2021.includes('Prefer') 
      ? `\n(I voted ${pastVote2021} in 2021)` 
      : '';
    
    const shareText = `I just took the Canadian Vote Spectrum quiz!

My top matches:
1. ${sortedParties[0].name} - ${sortedParties[0].alignment.toFixed(0)}%
2. ${sortedParties[1].name} - ${sortedParties[1].alignment.toFixed(0)}%
3. ${sortedParties[2].name} - ${sortedParties[2].alignment.toFixed(0)}%${pastVoteNote}

Find out where you stand on Canadian politics!

@northernvariables`;

    const shareUrl = 'https://axorc.substack.com';
    
    const handleThreadsShare = () => {
      const threadsUrl = `https://threads.net/intent/post?text=${encodeURIComponent(shareText)}`;
      window.open(threadsUrl, '_blank', 'noopener,noreferrer');
    };

    const handleFacebookShare = () => {
      const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`;
      window.open(fbUrl, '_blank', 'noopener,noreferrer');
    };

    const handleCopyResults = () => {
      navigator.clipboard.writeText(shareText).then(() => {
        alert('Results copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy results. Please try again.');
      });
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-red-50 p-4 py-8">
        <div className="max-w-6xl mx-auto">
          {dataSubmitted && (
            <div className="mb-6 bg-green-100 border-2 border-green-600 rounded-lg p-4 text-center">
              <p className="text-lg font-bold text-green-800">
                Thank you for contributing to Canadian political research!
              </p>
              <p className="text-sm text-green-700">
                Your anonymized responses have been securely submitted. This helps us understand Canadian political trends.
              </p>
            </div>
          )}
          
          <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div className="flex justify-between items-start mb-6">
              <div>
                <h2 className="text-3xl font-bold text-gray-900 mb-2">Your Results</h2>
                <p className="text-gray-600">
                  Based on your responses to {Object.keys(responses).length} questions 
                  ({federalQs} federal{provincialQs > 0 ? `, ${provincialQs} ${province} provincial` : ''})
                </p>
              </div>
              <div className={`px-4 py-2 rounded-full text-sm font-semibold ${
                confidence === 'high' ? 'bg-green-100 text-green-800' :
                confidence === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                'bg-red-100 text-red-800'
              }`}>
                {confidence.toUpperCase()} CONFIDENCE
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
              <div 
                className="p-6 rounded-xl shadow-lg border-4 text-center"
                style={{ 
                  borderColor: sortedParties[0].color,
                  backgroundColor: `${sortedParties[0].color}15`
                }}
              >
                <div className="text-sm font-semibold text-gray-600 mb-2">YOUR TOP FEDERAL MATCH</div>
                <div className="flex items-center justify-center gap-3">
                  <div 
                    className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl"
                    style={{ backgroundColor: sortedParties[0].color }}
                  >
                    #1
                  </div>
                  <div className="text-left">
                    <div className="text-2xl font-bold" style={{ color: sortedParties[0].color }}>
                      {sortedParties[0].name}
                    </div>
                    <div className="text-lg font-semibold text-gray-700">
                      {sortedParties[0].alignment.toFixed(0)}% match
                    </div>
                  </div>
                </div>
              </div>
              
              {provincialQs > 0 && sortedProvincialParties.length > 0 && (
                <div 
                  className="p-6 rounded-xl shadow-lg border-4 text-center"
                  style={{ 
                    borderColor: sortedProvincialParties[0].color,
                    backgroundColor: `${sortedProvincialParties[0].color}15`
                  }}
                >
                  <div className="text-sm font-semibold text-gray-600 mb-2">YOUR TOP {province} PROVINCIAL MATCH</div>
                  <div className="flex items-center justify-center gap-3">
                    <div 
                      className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl"
                      style={{ backgroundColor: sortedProvincialParties[0].color }}
                    >
                      #1
                    </div>
                    <div className="text-left">
                      <div className="text-2xl font-bold" style={{ color: sortedProvincialParties[0].color }}>
                        {sortedProvincialParties[0].name}
                      </div>
                      <div className="text-lg font-semibold text-gray-700">
                        {sortedProvincialParties[0].alignment.toFixed(0)}% match
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {pastVote2021 && !pastVote2021.includes('not') && !pastVote2021.includes('Prefer') && (
              <div className="mb-8 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border-2 border-purple-200">
                <h3 className="text-xl font-bold text-gray-900 mb-3">
                  How Your Views Have Evolved
                </h3>
                <p className="text-gray-700 mb-2">
                  In 2021, you voted <strong>{pastVote2021}</strong>.
                </p>
                <p className="text-gray-700">
                  {sortedParties[0].name === pastVote2021 ? (
                    <span className="text-green-700 font-semibold">
                      Your top match is still {pastVote2021}! Your views appear consistent with your past voting behavior.
                    </span>
                  ) : (
                    <span className="text-blue-700 font-semibold">
                      Your top match is now {sortedParties[0].name}. Your political positioning may have shifted since 2021, 
                      or your priorities may have changed in response to current issues.
                    </span>
                  )}
                </p>
              </div>
            )}

            {consistencyIssues.length > 0 && (
              <div className="mb-8 bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                <h3 className="text-lg font-bold text-yellow-900 mb-2">Consistency Note</h3>
                <ul className="list-disc list-inside space-y-1 text-yellow-800">
                  {consistencyIssues.map((issue, idx) => (
                    <li key={idx}>{issue}</li>
                  ))}
                </ul>
              </div>
            )}

            <div className="grid md:grid-cols-2 gap-8 mb-8">
              <div>
                <h3 className="text-xl font-bold mb-4">Political Positioning</h3>
                <ResponsiveContainer width="100%" height={300}>
                  <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis 
                      type="number" 
                      dataKey="x" 
                      domain={[-1, 1]} 
                      label={{ value: 'Economic: Left to Right', position: 'bottom' }}
                      ticks={[-1, -0.5, 0, 0.5, 1]}
                    />
                    <YAxis 
                      type="number" 
                      dataKey="y" 
                      domain={[-1, 1]} 
                      label={{ value: 'Social: Liberal to Conservative', angle: -90, position: 'left' }}
                      ticks={[-1, -0.5, 0, 0.5, 1]}
                    />
                    <ZAxis type="number" dataKey="z" range={[100, 400]} />
                    <Tooltip 
                      content={({ payload }) => {
                        if (payload && payload[0]) {
                          return (
                            <div className="bg-white p-2 border-2 border-gray-300 rounded shadow-lg">
                              <p className="font-bold">{payload[0].payload.name}</p>
                            </div>
                          );
                        }
                        return null;
                      }}
                    />
                    <Scatter data={scatterData}>
                      {scatterData.map((entry, index) => (
                        <Cell key={index} fill={entry.color} />
                      ))}
                    </Scatter>
                  </ScatterChart>
                </ResponsiveContainer>
              </div>

              <div>
                <h3 className="text-xl font-bold mb-4">Party Alignment</h3>
                <div className="space-y-3">
                  {sortedParties.map((party, idx) => (
                    <div key={party.code}>
                      <div className="flex justify-between items-center mb-1">
                        <span className="font-semibold" style={{ color: party.color }}>
                          {idx + 1}. {party.name}
                        </span>
                        <span className="font-bold">{party.alignment.toFixed(1)}%</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-3">
                        <div
                          className="h-3 rounded-full transition-all duration-500"
                          style={{ 
                            width: `${party.alignment}%`,
                            backgroundColor: party.color
                          }}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-xl font-bold mb-4">Your Axis Positions</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {Object.entries(axisScores).slice(0, 8).map(([axis, score]) => (
                  <div key={axis} className="bg-gray-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">
                      {axis.replace(/_/g, ' ').toUpperCase()}
                    </div>
                    <div className="text-2xl font-bold" style={{
                      color: score < -0.3 ? '#3B82F6' : score > 0.3 ? '#EF4444' : '#6B7280'
                    }}>
                      {score > 0 ? '+' : ''}{(score * 100).toFixed(0)}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl shadow-xl p-8 mb-6">
            <h3 className="text-2xl font-bold text-gray-900 mb-4 text-center">Share Your Results</h3>
            <p className="text-gray-600 text-center mb-6">
              Let others know where you stand on the political spectrum!
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <button
                onClick={handleThreadsShare}
                className="flex items-center justify-center gap-3 px-6 py-3 bg-black hover:bg-gray-800 text-white font-semibold rounded-lg transition-colors shadow-lg"
              >
                <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12.186 3.5c-3.763 0-6.815 3.052-6.815 6.815 0 1.546.516 2.97 1.384 4.113L4.5 20.5l6.072-2.255c1.143.868 2.567 1.384 4.113 1.384 3.763 0 6.815-3.052 6.815-6.815S15.949 3.5 12.186 3.5zm0 11.13c-2.38 0-4.315-1.935-4.315-4.315s1.935-4.315 4.315-4.315 4.315 1.935 4.315 4.315-1.935 4.315-4.315 4.315z"/>
                </svg>
                Share to Threads
              </button>
              <button
                onClick={handleFacebookShare}
                className="flex items-center justify-center gap-3 px-6 py-3 bg-[#1877F2] hover:bg-[#166FE5] text-white font-semibold rounded-lg transition-colors shadow-lg"
              >
                <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                Share to Facebook
              </button>
              <button
                onClick={handleCopyResults}
                className="flex items-center justify-center gap-3 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors shadow-lg"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                Copy Results
              </button>
            </div>
          </div>

          <div className="text-center">
            <button
              onClick={() => {
                setScreen('welcome');
                setProvince('');
                setResponses({});
                setQuestionImportance({});
                setImportance({});
                setKnowledgeAnswers({});
                setStrategyAnswers({});
                setPastVote2021('');
                setCurrentQuestionIndex(0);
                setShowMilestone(false);
                setMilestonesShown(new Set());
                setConsentToShare(false);
                setDataSubmitted(false);
              }}
              className="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-colors"
            >
              Start Over
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="font-sans min-h-screen flex flex-col">
      <div className="flex-1">
        {screen === 'welcome' && <WelcomeScreen />}
        {screen === 'province' && <ProvinceScreen />}
        {screen === 'past-vote' && <PastVoteScreen />}
        {screen === 'questions' && <QuestionsScreen />}
        {screen === 'importance' && <ImportanceScreen />}
        {screen === 'knowledge' && <KnowledgeScreen />}
        {screen === 'consent' && <ConsentScreen />}
        {screen === 'results' && <ResultsScreen />}
      </div>
      
      <footer className="bg-gray-900 text-white py-6 px-4 mt-auto">
        <div className="max-w-6xl mx-auto text-center">
          <p className="text-sm mb-2">
            {new Date().getFullYear()} Northern Variables. All rights reserved.
          </p>
          <p className="text-sm text-gray-400">
            Read more political analysis at{' '}
            <a 
              href="https://axorc.substack.com" 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-400 hover:text-blue-300 underline transition-colors"
            >
              Northern Variables on Substack
            </a>
          </p>
        </div>
      </footer>
    </div>
  );
};

export default VoteCompass;
